<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SciMath Academy - Duolingo Style Learning</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header Section */
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #4a90e2;
        }

        .progress-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .overall-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar {
            width: 200px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
        }

        .stats {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            color: #333;
        }

        .xp { color: #FF9800; }
        .streak { color: #E91E63; }
        .tokens { color: #9C27B0; }

        /* Main Content Area */
        .main-container {
            max-width: 800px;
            margin: 30px auto;
            padding: 0 20px;
        }

        /* Lesson Selection Screen */
        .lesson-selector {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .subject-tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .subject-tab {
            padding: 15px 30px;
            border-radius: 25px;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .subject-tab.active {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .lessons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .lesson-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .lesson-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .lesson-card.locked {
            background: #ccc;
            cursor: not-allowed;
        }

        .lesson-card.completed {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
        }

        .lesson-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .lesson-progress {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Question Area */
        .question-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .question-container.active {
            display: block;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .question-number {
            background: #4a90e2;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .lesson-progress-bar {
            flex: 1;
            margin: 0 20px;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }

        .lesson-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.5s ease;
        }

        .question-content {
            margin-bottom: 30px;
        }

        .question-text {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .question-image {
            max-width: 100%;
            border-radius: 10px;
            margin: 20px 0;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .option-btn {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 1.1rem;
        }

        .option-btn:hover {
            border-color: #4a90e2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.2);
        }

        .option-btn.selected {
            border-color: #4a90e2;
            background: #e3f2fd;
        }

        .option-btn.correct {
            border-color: #4CAF50;
            background: #e8f5e8;
        }

        .option-btn.incorrect {
            border-color: #f44336;
            background: #ffebee;
        }

        /* AI Hint Area */
        .hint-area {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: none;
            border-left: 5px solid #4a90e2;
        }

        .rich-hint-grid { display:grid; gap:14px; margin-top:14px; }
        .rich-section { background:#fff; border:1px solid #e2e8f0; padding:12px 14px; border-radius:12px; }
        .rich-section h4 { margin:0 0 6px; font-size:0.85rem; letter-spacing:.5px; color:#4a5568; text-transform:uppercase; }
        .steps-list { list-style:decimal; margin:4px 0 0 18px; padding:0; }
        .steps-list li { margin-bottom:4px; font-size:0.9rem; }
        .mnemonic-pill { display:inline-block; background:#e3f2fd; color:#1e3a8a; padding:4px 10px; border-radius:20px; font-size:0.75rem; font-weight:600; }
        .encouragement { font-weight:600; color:#2563eb; }
        .misconception { color:#b45309; font-size:0.85rem; }
        .answer-rationale { font-size:0.85rem; color:#374151; line-height:1.4; }
        .toggle-link { cursor:pointer; color:#2563eb; font-size:0.75rem; font-weight:600; margin-left:6px; }

        .hint-area.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .hint-title {
            font-weight: bold;
            color: #4a90e2;
            margin-bottom: 10px;
        }

        .hint-content {
            color: #666;
            line-height: 1.5;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4a90e2, #667eea);
            color: white;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-success {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .pulse-animation {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1.1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1.1); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Results Screen */
        .results-screen {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .results-screen.active {
            display: block;
            animation: slideIn 0.5s ease;
        }

        .results-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .results-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .results-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .result-stat {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4a90e2;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        /* Daily Challenge */
        .daily-challenge {
            background: linear-gradient(135deg, #FF6B6B, #FFE66D);
            color: white;
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
        }

        .challenge-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .challenge-description {
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .challenge-reward {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 15px;
            display: inline-block;
        }

        /* Leaderboard */
        .leaderboard {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .leaderboard-title {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }

        .rank {
            font-weight: bold;
            color: #4a90e2;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .progress-section {
                flex-direction: column;
                gap: 10px;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }

            .subject-tabs {
                flex-direction: column;
                gap: 10px;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        /* Animations and Effects */
        .bounce {
            animation: bounce 0.6s ease;
        }

        @keyframes bounce {
            0%, 20%, 60%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            80% { transform: translateY(-5px); }
        }

        .shake {
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4a90e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Achievement Popup */
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            text-align: center;
            display: none;
        }

        .achievement-popup.show {
            display: block;
            animation: popIn 0.5s ease;
        }

        @keyframes popIn {
            from { transform: translate(-50%, -50%) scale(0.7); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .achievement-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1500;
            display: none;
        }

        .overlay.show {
            display: block;
        }

    </style>
</head>
<body>
    <!-- Header Section -->
    <header class="header">
        <div class="header-content">
            <div class="logo">🧪 SciMath Academy</div>
            <div class="progress-section">
                <div class="overall-progress">
                    <span>Overall Progress:</span>
                    <div class="progress-bar">
                        <div class="progress-fill" id="overallProgress"></div>
                    </div>
                </div>
                <div class="stats">
                    <div class="stat-item xp">
                        ⭐ <span id="xpCount">0</span> XP
                    </div>
                    <div class="stat-item streak">
                        🔥 <span id="streakCount">0</span> Streak
                    </div>
                    <div class="stat-item tokens">
                        🪙 <span id="tokenCount">0</span> Tokens
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Lesson Selector -->
        <div class="lesson-selector" id="lessonSelector">
            <h1>Choose Your Learning Path</h1>
            <p>Master Science and Mathematics through interactive lessons</p>
            
            <div class="subject-tabs">
                <button class="subject-tab active" data-subject="science">🧪 Science</button>
                <button class="subject-tab" data-subject="maths">📊 Mathematics</button>
            </div>

            <div class="lessons-grid" id="lessonsGrid">
                <!-- Lessons will be populated dynamically -->
            </div>
        </div>

        <!-- Daily Challenge -->
        <div class="daily-challenge" id="dailyChallenge">
            <div class="challenge-title">🏆 Daily Challenge</div>
            <div class="challenge-description">Complete 5 lessons today for bonus rewards!</div>
            <div class="challenge-reward">+50 XP & 10 Tokens</div>
        </div>

        <!-- Question Container -->
        <div class="question-container" id="questionContainer">
            <div class="question-header">
                <div class="question-number" id="questionNumber">Question 1/10</div>
                <div class="lesson-progress-bar">
                    <div class="lesson-progress-fill" id="lessonProgressFill"></div>
                </div>
            </div>

            <div class="question-content">
                <div class="question-text" id="questionText">Loading question...</div>
                <img class="question-image" id="questionImage" style="display: none;">
                
                <div class="options-grid" id="optionsGrid">
                    <!-- Options will be populated dynamically -->
                </div>
            </div>

            <div class="hint-area" id="hintArea">
                <div class="hint-title">💡 AI Hint</div>
                <div class="hint-content" id="hintContent"></div>
                <div id="richHintContainer" style="display:none;">
                    <div class="rich-hint-grid" id="richHintGrid"></div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" id="hintBtn">💡 Get Hint</button>
                <button class="btn btn-primary" id="submitBtn" disabled>Submit Answer</button>
                <button class="btn btn-success" id="nextBtn" style="display: none;">Next Question →</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div class="results-screen" id="resultsScreen">
            <div class="results-icon" id="resultsIcon">🎉</div>
            <div class="results-title" id="resultsTitle">Lesson Complete!</div>
            <div class="results-stats">
                <div class="result-stat">
                    <div class="stat-value" id="finalScore">8/10</div>
                    <div class="stat-label">Score</div>
                </div>
                <div class="result-stat">
                    <div class="stat-value" id="earnedXP">+120</div>
                    <div class="stat-label">XP Earned</div>
                </div>
                <div class="result-stat">
                    <div class="stat-value" id="earnedTokens">+15</div>
                    <div class="stat-label">Tokens</div>
                </div>
                <div class="result-stat">
                    <div class="stat-value" id="accuracyPercent">80%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-secondary" id="reviewBtn">📖 Review Mistakes</button>
                <button class="btn btn-primary" id="continueBtn">Continue Learning</button>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="leaderboard" id="leaderboard">
            <div class="leaderboard-title">🏆 Top Learners</div>
            <div id="leaderboardContent">
                <!-- Leaderboard items will be populated -->
            </div>
        </div>
    </div>

    <!-- Achievement Popup -->
    <div class="overlay" id="overlay"></div>
    <div class="achievement-popup" id="achievementPopup">
        <div class="achievement-icon" id="achievementIcon">🏅</div>
        <div class="achievement-title" id="achievementTitle">Achievement Unlocked!</div>
        <div class="achievement-description" id="achievementDescription">You've completed your first lesson!</div>
        <button class="btn btn-primary" onclick="closeAchievement()">Awesome!</button>
    </div>


    <script>
        // Global State Management
        const AppState = {
            currentSubject: 'science',
            currentLesson: null,
            currentQuestionIndex: 0,
            questions: [],
            answers: [],
            score: 0,
            xp: parseInt(localStorage.getItem('xp') || '0'),
            tokens: parseInt(localStorage.getItem('tokens') || '0'),
            streak: parseInt(localStorage.getItem('streak') || '0'),
            lessonsCompleted: JSON.parse(localStorage.getItem('lessonsCompleted') || '{}'),
            dailyProgress: parseInt(localStorage.getItem('dailyProgress') || '0'),
            selectedOption: null
        };

        // API Configuration
        const API_BASE = 'http://127.0.0.1:5000/api/duolingo';

        // Lesson Structure for Classes 6-10
        const LESSONS = {
            science: [
                { id: 'light-class6', title: 'Light - Shadows and Reflections', class: 6, topics: ['Light sources', 'Shadows', 'Reflection'] },
                { id: 'electricity-class6', title: 'Electricity and Circuits', class: 6, topics: ['Electric circuits', 'Switches', 'Conductors'] },
                { id: 'magnets-class6', title: 'Fun with Magnets', class: 6, topics: ['Magnetic materials', 'Poles', 'Compass'] },
                { id: 'heat-class7', title: 'Heat', class: 7, topics: ['Temperature', 'Heat transfer', 'Expansion'] },
                { id: 'acids-class7', title: 'Acids, Bases and Salts', class: 7, topics: ['Indicators', 'Neutralization', 'Applications'] },
                { id: 'motion-class8', title: 'Force and Motion', class: 8, topics: ['Types of motion', 'Force', 'Friction'] },
                { id: 'sound-class8', title: 'Sound', class: 8, topics: ['Vibrations', 'Frequency', 'Amplitude'] },
                { id: 'gravitation-class9', title: 'Gravitation', class: 9, topics: ['Gravity', 'Mass vs Weight', 'Free fall'] },
                { id: 'atoms-class9', title: 'Structure of Atom', class: 9, topics: ['Electrons', 'Protons', 'Neutrons'] },
                { id: 'carbon-class10', title: 'Carbon and its Compounds', class: 10, topics: ['Organic chemistry', 'Functional groups', 'Reactions'] },
                { id: 'heredity-class10', title: 'Heredity and Evolution', class: 10, topics: ['Genetics', 'DNA', 'Natural selection'] }
            ],
            maths: [
                { id: 'integers-class6', title: 'Integers', class: 6, topics: ['Positive numbers', 'Negative numbers', 'Operations'] },
                { id: 'fractions-class6', title: 'Fractions and Decimals', class: 6, topics: ['Proper fractions', 'Improper fractions', 'Decimals'] },
                { id: 'geometry-class6', title: 'Basic Geometrical Ideas', class: 6, topics: ['Points', 'Lines', 'Angles'] },
                { id: 'algebra-class7', title: 'Simple Equations', class: 7, topics: ['Variables', 'Solving equations', 'Applications'] },
                { id: 'triangles-class7', title: 'The Triangle and its Properties', class: 7, topics: ['Types', 'Angle sum', 'Exterior angle'] },
                { id: 'rational-class8', title: 'Rational Numbers', class: 8, topics: ['Properties', 'Operations', 'Representation'] },
                { id: 'quadrilaterals-class8', title: 'Understanding Quadrilaterals', class: 8, topics: ['Types', 'Properties', 'Angle sum'] },
                { id: 'polynomials-class9', title: 'Polynomials', class: 9, topics: ['Degree', 'Factorization', 'Zeros'] },
                { id: 'coordinate-class9', title: 'Coordinate Geometry', class: 9, topics: ['Cartesian plane', 'Distance', 'Section formula'] },
                { id: 'trigonometry-class10', title: 'Introduction to Trigonometry', class: 10, topics: ['Ratios', 'Identities', 'Heights and distances'] },
                { id: 'statistics-class10', title: 'Statistics', class: 10, topics: ['Mean', 'Median', 'Mode'] }
            ]
        };

        // Sample NCERT Questions Database
        const QUESTION_DATABASE = {
            'light-class6': [
                {
                    id: 1,
                    text: 'Which of the following is a luminous object?',
                    options: ['Moon', 'Mirror', 'Candle flame', 'Book'],
                    correct: 2,
                    explanation: 'A candle flame produces its own light, making it luminous. Moon and mirror reflect light.',
                    concept: 'Light sources',
                    difficulty: 'easy'
                },
                {
                    id: 2,
                    text: 'What happens when light falls on a smooth surface like a mirror?',
                    options: ['Absorption', 'Reflection', 'Refraction', 'Diffraction'],
                    correct: 1,
                    explanation: 'Smooth surfaces like mirrors reflect light following the law of reflection.',
                    concept: 'Reflection',
                    difficulty: 'easy'
                }
            ],
            'integers-class6': [
                {
                    id: 1,
                    text: 'What is (-5) + (+3)?',
                    options: ['-8', '-2', '+2', '+8'],
                    correct: 1,
                    explanation: 'When adding integers with different signs, subtract and keep the sign of larger number.',
                    concept: 'Integer addition',
                    difficulty: 'easy'
                },
                {
                    id: 2,
                    text: 'Which number is smaller: -10 or -5?',
                    options: ['-10', '-5', 'Both are equal', 'Cannot determine'],
                    correct: 0,
                    explanation: 'On number line, -10 is to the left of -5, making it smaller.',
                    concept: 'Comparing integers',
                    difficulty: 'easy'
                }
            ]
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            updateUI();
        });

        function initializeApp() {
            // Load saved progress
            updateStatsDisplay();
            renderLessons();
            loadDailyChallenge();
            loadLeaderboard();
        }

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Subject tabs
            document.querySelectorAll('.subject-tab').forEach(tab => {
                tab.addEventListener('click', (e) => switchSubject(e.target.dataset.subject));
            });

            // Question buttons
            const hintBtn = document.getElementById('hintBtn');
            const submitBtn = document.getElementById('submitBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            console.log('Button elements found:', {
                hintBtn: !!hintBtn,
                submitBtn: !!submitBtn,
                nextBtn: !!nextBtn
            });
            
            if (hintBtn) {
                hintBtn.addEventListener('click', getAIHint);
                console.log('Hint button event listener added');
            } else {
                console.error('Hint button not found during setup!');
            }
            
            if (submitBtn) {
                submitBtn.addEventListener('click', function(e) {
                    console.log('Submit button clicked via event listener');
                    submitAnswer();
                });
                console.log('Submit button event listener added');
                console.log('Submit button initial state:', {
                    display: submitBtn.style.display,
                    disabled: submitBtn.disabled,
                    visible: submitBtn.offsetHeight > 0
                });
            } else {
                console.error('Submit button not found during setup!');
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', nextQuestion);
                console.log('Next button event listener added');
            } else {
                console.error('Next button not found during setup!');
            }
            
            // Results buttons
            const continueBtn = document.getElementById('continueBtn');
            const reviewBtn = document.getElementById('reviewBtn');
            
            if (continueBtn) {
                continueBtn.addEventListener('click', returnToLessons);
            }
            if (reviewBtn) {
                reviewBtn.addEventListener('click', reviewMistakes);
            }
        }

        function switchSubject(subject) {
            AppState.currentSubject = subject;
            
            // Update active tab
            document.querySelectorAll('.subject-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-subject="${subject}"]`).classList.add('active');
            
            // Re-render lessons
            renderLessons();
        }

        function renderLessons() {
            const grid = document.getElementById('lessonsGrid');
            const lessons = LESSONS[AppState.currentSubject];
            
            grid.innerHTML = lessons.map((lesson, index) => {
                const isCompleted = AppState.lessonsCompleted[lesson.id];
                const isLocked = index > 0 && !AppState.lessonsCompleted[lessons[index-1].id];
                
                let statusClass = '';
                if (isCompleted) statusClass = 'completed';
                else if (isLocked) statusClass = 'locked';
                
                return `
                    <div class="lesson-card ${statusClass}" onclick="${isLocked ? '' : `startLesson('${lesson.id}')`}">
                        <div class="lesson-title">${lesson.title}</div>
                        <div class="lesson-progress">Class ${lesson.class} • ${lesson.topics.length} topics</div>
                        ${isCompleted ? '<div style="margin-top: 10px;">✅ Completed</div>' : ''}
                        ${isLocked ? '<div style="margin-top: 10px;">🔒 Locked</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        async function startLesson(lessonId) {
            AppState.currentLesson = lessonId;
            AppState.currentQuestionIndex = 0;
            AppState.answers = [];
            AppState.score = 0;
            AppState.selectedOption = null;

            // Load questions for this lesson
            try {
                // Try to fetch from API first
                const response = await fetch(`${API_BASE}/questions/lesson`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lesson_id: lessonId,
                        count: 10
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    AppState.questions = data.questions || [];
                } else {
                    throw new Error('API not available');
                }
            } catch (error) {
                // Fallback to local questions
                console.log('Using local question database for lesson:', lessonId);
                AppState.questions = QUESTION_DATABASE[lessonId] || [];
                
                // If no local questions, generate some basic ones
                if (AppState.questions.length === 0) {
                    console.log('No questions found, generating samples');
                    AppState.questions = generateSampleQuestions(lessonId);
                }
                console.log('Loaded questions:', AppState.questions.length);
            }

            // Show question container
            document.getElementById('lessonSelector').style.display = 'none';
            document.getElementById('dailyChallenge').style.display = 'none';
            document.getElementById('leaderboard').style.display = 'none';
            document.getElementById('questionContainer').classList.add('active');
            
            // Load first question
            loadQuestion();
        }
        
        // Make startLesson available globally
        window.startLesson = startLesson;

        function generateSampleQuestions(lessonId) {
            // Generate basic questions for any lesson
            const lesson = LESSONS[AppState.currentSubject].find(l => l.id === lessonId);
            if (!lesson) return [];

            const options = lesson.topics.slice(0, 3).concat(['None of the above']);
            return [
                {
                    id: 1,
                    text: `What is the main topic covered in "${lesson.title}"?`,
                    options: options,
                    correct: 0,
                    explanation: `This lesson covers ${lesson.topics[0]} and related concepts.`,
                    concept: lesson.title,
                    difficulty: 'easy'
                }
            ];
        }

        function loadQuestion() {
            console.log('Loading question. Index:', AppState.currentQuestionIndex, 'Total questions:', AppState.questions.length);
            if (AppState.currentQuestionIndex >= AppState.questions.length) {
                console.log('All questions completed, showing results');
                showResults();
                return;
            }

            const question = AppState.questions[AppState.currentQuestionIndex];
            
            // Validate question structure
            if (!question || !question.options || !Array.isArray(question.options) || 
                question.correct < 0 || question.correct >= question.options.length) {
                console.error('Invalid question structure:', question);
                // Skip to next question or show error
                AppState.currentQuestionIndex++;
                if (AppState.currentQuestionIndex < AppState.questions.length) {
                    loadQuestion();
                } else {
                    showResults();
                }
                return;
            }
            
            console.log('Loading question:', {
                text: question.text,
                options: question.options,
                correct: question.correct,
                optionsLength: question.options.length
            });
            
            // Update question display
            document.getElementById('questionNumber').textContent = 
                `Question ${AppState.currentQuestionIndex + 1}/${AppState.questions.length}`;
            document.getElementById('questionText').textContent = question.text;
            
            // Update progress bar
            const progress = ((AppState.currentQuestionIndex) / AppState.questions.length) * 100;
            document.getElementById('lessonProgressFill').style.width = progress + '%';
            
            // Render options
            const optionsGrid = document.getElementById('optionsGrid');
            if (question.options && question.options.length > 0) {
                optionsGrid.innerHTML = question.options.map((option, index) => `
                    <button class="option-btn" onclick="selectOption(${index})">
                        ${String.fromCharCode(65 + index)}. ${option}
                    </button>
                `).join('');
                console.log('Rendered', question.options.length, 'options');
            } else {
                console.error('No options to render for question');
                optionsGrid.innerHTML = '<p>Error: No options available for this question</p>';
            }
            
            // Reset UI state
            document.getElementById('hintArea').classList.remove('show');
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').style.display = 'inline-block';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('hintBtn').style.display = 'inline-block';
            AppState.selectedOption = null;
            console.log('Submit button should be visible now');
        }

        function selectOption(index) {
            console.log('Option selected:', index);
            // Remove previous selection
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Add selection to clicked option
            document.querySelectorAll('.option-btn')[index].classList.add('selected');
            
            AppState.selectedOption = index;
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.style.display = 'inline-block';
                console.log('Submit button enabled and shown, selectedOption:', AppState.selectedOption);
                console.log('Submit button styles:', {
                    display: submitBtn.style.display,
                    disabled: submitBtn.disabled,
                    visible: submitBtn.offsetHeight > 0
                });
            } else {
                console.error('Submit button not found!');
            }
        }
        
        // Make selectOption available globally
        window.selectOption = selectOption;

        async function getAIHint() {
            const question = AppState.questions[AppState.currentQuestionIndex];
            const hintArea = document.getElementById('hintArea');
            const hintContent = document.getElementById('hintContent');
            const richContainer = document.getElementById('richHintContainer');
            const richGrid = document.getElementById('richHintGrid');
            
            document.querySelector('.hint-title').textContent = '💡 AI Hint';
            hintContent.innerHTML = '<div style="text-align: center;">🤖 Thinking...</div>';
            hintArea.classList.add('show');
            richContainer.style.display = 'none';
            richGrid.innerHTML = '';
            
            try {
                const response = await fetch(`${API_BASE}/hint/ai?mode=rich`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: question.text,
                        options: question.options,
                        concept: question.concept,
                        question_id: question.id,
                        mode: 'rich'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.mode === 'rich') {
                        hintContent.innerHTML = `<strong>${data.hint || 'Reflect on the core concept.'}</strong>`;
                        const steps = (data.steps || []).map(s => `<li>${s}</li>`).join('');
                        const misconception = data.misconception ? `<div class="rich-section"><h4>Misconception</h4><div class="misconception">${data.misconception}</div></div>` : '';
                        const mnemonic = data.mnemonic ? `<div class="rich-section"><h4>Mnemonic</h4><div class="mnemonic-pill">${data.mnemonic}</div></div>` : '';
                        const conceptRecap = data.concept_recap ? `<div class="rich-section"><h4>Concept Recap</h4><div>${data.concept_recap}</div></div>` : '';
                        const stepBlock = steps ? `<div class="rich-section"><h4>Steps</h4><ol class="steps-list">${steps}</ol></div>` : '';
                        const encouragement = data.encouragement ? `<div class="rich-section"><h4>Encouragement</h4><div class="encouragement">${data.encouragement}</div></div>` : '';
                        richGrid.innerHTML = conceptRecap + stepBlock + misconception + mnemonic + encouragement;
                        richContainer.style.display = 'block';
                    } else {
                        hintContent.innerHTML = data.hint || data.explanation || 'Consider the key concepts related to this topic.';
                    }
                } else {
                    throw new Error('AI hint not available');
                }
            } catch (error) {
                console.log('AI hint failed, using custom hint');
                hintContent.innerHTML = generateCustomHint(question);
            }
        }
        
        function generateCustomHint(question) {
            const concept = question.concept;
            let hint = '';
            
            // Generate concept-specific hints
            if (concept && concept.toLowerCase().includes('light')) {
                hint = `💡 <strong>Think about light sources:</strong><br>• What objects produce their own light?<br>• What objects only reflect light from other sources?<br>• Remember: luminous vs non-luminous objects`;
            } else if (concept && concept.toLowerCase().includes('shadow')) {
                hint = `🌑 <strong>Think about how shadows form:</strong><br>• What happens when light hits an opaque object?<br>• Can light pass through, around, or get blocked?<br>• Remember: shadows form when light is blocked`;
            } else if (concept && concept.toLowerCase().includes('reflection')) {
                hint = `🪞 <strong>Think about reflection:</strong><br>• What surfaces reflect light well?<br>• How does light behave on smooth vs rough surfaces?<br>• Remember: mirrors reflect light following certain laws`;
            } else if (concept && concept.toLowerCase().includes('integer')) {
                hint = `🔢 <strong>Think about integers:</strong><br>• Consider positive and negative numbers<br>• Remember the number line<br>• Which direction represents smaller values?`;
            } else if (question.explanation) {
                hint = `💭 <strong>Key concept:</strong><br>${question.explanation}`;
            } else {
                hint = `🧠 <strong>Think carefully about:</strong><br>• ${concept}<br>• Read each option carefully<br>• Consider what you've learned about this topic`;
            }
            
            return hint;
        }

        async function submitAnswer() {
            console.log('Submit button clicked. Selected option:', AppState.selectedOption);
            if (AppState.selectedOption === null) {
                console.log('No option selected, returning');
                return;
            }
            
            const question = AppState.questions[AppState.currentQuestionIndex];
            let isCorrect = false;
            let correctAnswer = null;
            let explanation = '';
            
            try {
                // Check answer via API
                const response = await fetch(`${API_BASE}/answer/check?rich_explanation=true`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question_id: question.id,
                        lesson_id: AppState.currentLesson,
                        selected_option: AppState.selectedOption,
                        student_id: 'default'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    isCorrect = result.correct;
                    correctAnswer = result.correct_option;
                    explanation = result.explanation || '';
                    // If rich tutoring present, show immediately (for both correct & wrong to reinforce learning)
                    if (result.rich_tutoring) {
                        renderRichExplanation(result, question, isCorrect);
                    }
                    if (!isCorrect && result.wrong_analysis && !result.rich_tutoring) {
                        renderWrongOnlyAnalysis(result.wrong_analysis);
                    }
                    
                    console.log('=== API VALIDATION RESULT ===');
                    console.log('Question:', question.text);
                    console.log('Selected Option:', AppState.selectedOption);
                    console.log('Correct Answer:', correctAnswer);
                    console.log('Is Correct:', isCorrect);
                    console.log('Explanation:', explanation);
                    
                    // Update XP and tokens if correct
                    if (isCorrect) {
                        AppState.xp += result.xp_earned || 10;
                        AppState.tokens += result.tokens_earned || 1;
                    }
                } else {
                    throw new Error('API validation failed');
                }
            } catch (error) {
                console.error('Error validating answer via API:', error);
                // Fallback to local validation (though this will likely fail due to missing correct field)
                isCorrect = AppState.selectedOption === question.correct;
                correctAnswer = question.correct;
                console.log('Using fallback validation, result may be inaccurate');
            }
            
            // Store answer with correct data
            AppState.answers.push({
                questionId: question.id,
                selected: AppState.selectedOption,
                correct: correctAnswer,
                isCorrect: isCorrect,
                explanation: explanation
            });
            
            if (isCorrect) {
                AppState.score++;
            }
            
            // Update UI to show correct/incorrect
            const options = document.querySelectorAll('.option-btn');
            console.log('Options found:', options.length, 'Correct answer index:', correctAnswer, 'Selected option:', AppState.selectedOption);
            
            // Validate that we have the correct option element
            if (options.length > correctAnswer && correctAnswer >= 0) {
                options[correctAnswer].classList.add('correct');
            } else {
                console.error('Invalid correct answer index:', correctAnswer, 'Options available:', options.length);
            }
            
            // Update buttons BEFORE showing AI explanation to ensure they appear immediately
            const submitBtn = document.getElementById('submitBtn');
            const hintBtn = document.getElementById('hintBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            submitBtn.style.display = 'none';
            hintBtn.style.display = 'none';
            nextBtn.style.display = 'inline-block';
            
            console.log('Buttons updated immediately after submit');
            
            if (!isCorrect) {
                if (options.length > AppState.selectedOption && AppState.selectedOption >= 0) {
                    options[AppState.selectedOption].classList.add('incorrect');
                }
                if (!explanation && !document.getElementById('richHintContainer').style.display === 'block') {
                    showAIExplanation(question).catch(()=>{});
                } else if (explanation && !document.getElementById('richHintContainer').style.display === 'block') {
                    showExplanation(explanation);
                }
            }
            
            console.log('Final button states:', {
                submitHidden: submitBtn.style.display === 'none',
                hintHidden: hintBtn.style.display === 'none', 
                nextVisible: nextBtn.style.display === 'inline-block'
            });
            
            // Make next button very visible
            nextBtn.style.border = '3px solid #ff6b6b';
            nextBtn.style.backgroundColor = '#28a745';
            nextBtn.style.color = 'white';
            nextBtn.style.transform = 'scale(1.1)';
            nextBtn.style.boxShadow = '0 0 20px rgba(40, 167, 69, 0.5)';
            
            // Add pulsing animation
            nextBtn.classList.add('pulse-animation');
            
            // Show a brief notification
            const notification = document.createElement('div');
            notification.textContent = isCorrect ? '✅ Correct! Click Next →' : '❌ Incorrect. Click Next →';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${isCorrect ? '#28a745' : '#dc3545'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                font-weight: bold;
                z-index: 1000;
                animation: slideIn 0.5s ease;
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                nextBtn.style.border = '';
                nextBtn.style.transform = '';
                nextBtn.style.boxShadow = '';
                nextBtn.classList.remove('pulse-animation');
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
            
            // Award XP for correct answers
            if (isCorrect) {
                awardXP(10);
                showFloatingPoints('+10 XP');
            }
        }
        
        // Make submitAnswer available globally
        window.submitAnswer = submitAnswer;

        function showExplanation(explanation) {
            const hintArea = document.getElementById('hintArea');
            const hintContent = document.getElementById('hintContent');
            
            document.querySelector('.hint-title').textContent = '💡 Explanation';
            hintContent.innerHTML = `<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff;">${explanation}</div>`;
            hintArea.classList.add('show');
            
            console.log('Showing API explanation:', explanation);
        }

        function renderRichExplanation(result, question, isCorrect) {
            const hintArea = document.getElementById('hintArea');
            const hintContent = document.getElementById('hintContent');
            const richContainer = document.getElementById('richHintContainer');
            const richGrid = document.getElementById('richHintGrid');
            hintArea.classList.add('show');
            document.querySelector('.hint-title').textContent = isCorrect ? '🎯 Deep Understanding' : '🤔 Let\'s Learn From This';
            const rt = result.rich_tutoring || {};
            hintContent.innerHTML = `<strong>${rt.hint || 'Focus on the core rule.'}</strong>`;
            const steps = (rt.steps||[]).map(s=>`<li>${s}</li>`).join('');
            const blocks = [];
            if (rt.concept_recap) blocks.push(`<div class='rich-section'><h4>Concept Recap</h4><div>${rt.concept_recap}</div></div>`);
            if (steps) blocks.push(`<div class='rich-section'><h4>Steps</h4><ol class='steps-list'>${steps}</ol></div>`);
            if (rt.misconception) blocks.push(`<div class='rich-section'><h4>Misconception</h4><div class='misconception'>${rt.misconception}</div></div>`);
            if (rt.mnemonic) blocks.push(`<div class='rich-section'><h4>Mnemonic</h4><div class='mnemonic-pill'>${rt.mnemonic}</div></div>`);
            if (rt.wrong_option_explanation && !isCorrect) blocks.push(`<div class='rich-section'><h4>Your Choice</h4><div>${rt.wrong_option_explanation}</div></div>`);
            if (rt.answer_explanation) blocks.push(`<div class='rich-section'><h4>Why Correct</h4><div class='answer-rationale'>${rt.answer_explanation}</div></div>`);
            if (rt.answer_validation_rationale) blocks.push(`<div class='rich-section'><h4>Logic Chain</h4><div class='answer-rationale'>${rt.answer_validation_rationale}</div></div>`);
            if (rt.encouragement) blocks.push(`<div class='rich-section'><h4>Keep Going</h4><div class='encouragement'>${rt.encouragement}</div></div>`);
            richGrid.innerHTML = blocks.join('');
            richContainer.style.display = 'block';
        }

        function renderWrongOnlyAnalysis(analysis) {
            const hintArea = document.getElementById('hintArea');
            const hintContent = document.getElementById('hintContent');
            hintArea.classList.add('show');
            document.querySelector('.hint-title').textContent = '🤔 Why This Was Wrong';
            const wrong = analysis.wrong_option_explanation || analysis.analysis || 'Review the definition and compare carefully.';
            const contrast = analysis.contrast_with_correct ? `<div style='margin-top:8px;'><strong>Why Correct:</strong> ${analysis.contrast_with_correct}</div>` : '';
            hintContent.innerHTML = `<div style='background:#fff;border:1px solid #e2e8f0;padding:12px 14px;border-radius:12px;'>${wrong}${contrast}</div>`;
        }

        async function showAIExplanation(question) {
            const hintArea = document.getElementById('hintArea');
            const hintContent = document.getElementById('hintContent');
            
            document.querySelector('.hint-title').textContent = '🤔 Why was this wrong?';
            
            // Show loading state
            hintContent.innerHTML = '<div style="text-align: center;">🧠 Analyzing your answer...</div>';
            hintArea.classList.add('show');
            
            try {
                const selectedAnswer = question.options[AppState.selectedOption];
                const correctAnswer = question.options[question.correct];
                
                const response = await fetch(`${API_BASE}/hint/ai`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: question.text,
                        student_answer: selectedAnswer,
                        correct_answer: correctAnswer,
                        explanation: question.explanation,
                        concept: question.concept,
                        hint_type: "wrong_answer_guidance"
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    // Handle different response formats
                    let explanation = '';
                    if (data.steps && Array.isArray(data.steps)) {
                        explanation = data.steps.map(step => `• ${step}`).join('<br>');
                    } else if (data.hint) {
                        explanation = data.hint;
                    } else if (data.explanation) {
                        explanation = data.explanation;
                    } else {
                        throw new Error('Invalid AI response format');
                    }
                    hintContent.innerHTML = explanation;
                } else {
                    throw new Error('AI explanation not available');
                }
            } catch (error) {
                console.log('AI hint failed, using custom explanation');
                hintContent.innerHTML = generateCustomExplanation(question, AppState.selectedOption);
            }
        }
        
        function generateCustomExplanation(question, selectedIndex) {
            const selectedAnswer = question.options[selectedIndex];
            const correctAnswer = question.options[question.correct];
            
            // Generate contextual hints based on the question content
            let hint = `<div style="margin-bottom: 10px;"><strong>🎯 Your answer:</strong> ${selectedAnswer}</div>`;
            hint += `<div style="margin-bottom: 10px;"><strong>✅ Correct answer:</strong> ${correctAnswer}</div>`;
            
            // Add concept-based hint
            if (question.concept) {
                hint += `<div style="margin-bottom: 10px;"><strong>💡 Think about:</strong> ${question.concept}</div>`;
            }
            
            // Add specific explanation
            if (question.explanation) {
                hint += `<div><strong>📖 Key concept:</strong> ${question.explanation}</div>`;
            } else {
                // Generate basic hint based on question type
                hint += `<div><strong>💭 Hint:</strong> Look carefully at what the question is asking about and consider the fundamental concepts of ${question.concept || 'this topic'}.</div>`;
            }
            
            return hint;
        }

        function nextQuestion() {
            console.log('Next question clicked. Current index:', AppState.currentQuestionIndex);
            AppState.currentQuestionIndex++;
            console.log('Moving to question index:', AppState.currentQuestionIndex);
            loadQuestion();
        }
        
        // Make nextQuestion available globally
        window.nextQuestion = nextQuestion;

        function showResults() {
            const accuracy = Math.round((AppState.score / AppState.questions.length) * 100);
            const earnedXP = AppState.score * 15; // 15 XP per correct answer
            const earnedTokens = Math.floor(AppState.score / 2); // 1 token per 2 correct answers
            
            // Award final rewards
            awardXP(earnedXP);
            awardTokens(earnedTokens);
            
            // Update lesson completion
            AppState.lessonsCompleted[AppState.currentLesson] = true;
            localStorage.setItem('lessonsCompleted', JSON.stringify(AppState.lessonsCompleted));
            
            // Update daily progress
            AppState.dailyProgress++;
            localStorage.setItem('dailyProgress', AppState.dailyProgress.toString());
            
            // Check for achievements
            checkAchievements();
            
            // Show results screen
            document.getElementById('questionContainer').classList.remove('active');
            document.getElementById('finalScore').textContent = `${AppState.score}/${AppState.questions.length}`;
            document.getElementById('earnedXP').textContent = `+${earnedXP}`;
            document.getElementById('earnedTokens').textContent = `+${earnedTokens}`;
            document.getElementById('accuracyPercent').textContent = `${accuracy}%`;
            
            // Set results icon based on performance
            const resultsIcon = document.getElementById('resultsIcon');
            const resultsTitle = document.getElementById('resultsTitle');
            
            if (accuracy >= 90) {
                resultsIcon.textContent = '🏆';
                resultsTitle.textContent = 'Outstanding!';
            } else if (accuracy >= 70) {
                resultsIcon.textContent = '🎉';
                resultsTitle.textContent = 'Great Job!';
            } else if (accuracy >= 50) {
                resultsIcon.textContent = '👍';
                resultsTitle.textContent = 'Good Effort!';
            } else {
                resultsIcon.textContent = '📚';
                resultsTitle.textContent = 'Keep Learning!';
            }
            
            document.getElementById('resultsScreen').classList.add('active');
            
            // Send results to API
            submitResultsToAPI();
        }

        async function submitResultsToAPI() {
            try {
                const response = await fetch(`${API_BASE}/progress/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        student_id: 'student123',
                        achievement_type: 'lesson_complete',
                        subject: AppState.currentSubject,
                        score: Math.round((AppState.score / AppState.questions.length) * 100)
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Tokens awarded:', data.tokens_earned);
                }
            } catch (error) {
                console.log('Offline mode - results saved locally');
            }
        }

        function returnToLessons() {
            document.getElementById('resultsScreen').classList.remove('active');
            document.getElementById('lessonSelector').style.display = 'block';
            document.getElementById('dailyChallenge').style.display = 'block';
            document.getElementById('leaderboard').style.display = 'block';
            
            renderLessons(); // Refresh to show newly unlocked lessons
        }

        function reviewMistakes() {
            const mistakes = AppState.answers.filter(answer => !answer.isCorrect);
            
            if (mistakes.length === 0) {
                alert('Great job! You got all answers correct! 🎉');
                return;
            }
            
            let reviewContent = 'Questions you missed:\n\n';
            mistakes.forEach((mistake, index) => {
                const question = AppState.questions.find(q => q.id === mistake.questionId);
                if (question) {
                    reviewContent += `${index + 1}. ${question.text}\n`;
                    reviewContent += `Your answer: ${question.options[mistake.selected]}\n`;
                    reviewContent += `Correct answer: ${question.options[mistake.correct]}\n\n`;
                }
            });
            
            alert(reviewContent);
        }

        function awardXP(amount) {
            AppState.xp += amount;
            localStorage.setItem('xp', AppState.xp.toString());
            updateStatsDisplay();
        }

        function awardTokens(amount) {
            AppState.tokens += amount;
            localStorage.setItem('tokens', AppState.tokens.toString());
            updateStatsDisplay();
        }

        function updateStatsDisplay() {
            document.getElementById('xpCount').textContent = AppState.xp;
            document.getElementById('tokenCount').textContent = AppState.tokens;
            document.getElementById('streakCount').textContent = AppState.streak;
            
            // Update overall progress based on completed lessons
            const totalLessons = LESSONS.science.length + LESSONS.maths.length;
            const completedCount = Object.keys(AppState.lessonsCompleted).length;
            const overallProgress = (completedCount / totalLessons) * 100;
            document.getElementById('overallProgress').style.width = overallProgress + '%';
        }

        function showFloatingPoints(text) {
            const float = document.createElement('div');
            float.textContent = text;
            float.style.cssText = `
                position: fixed;
                top: 20%;
                left: 50%;
                transform: translateX(-50%);
                color: #4CAF50;
                font-weight: bold;
                font-size: 1.5rem;
                z-index: 1000;
                animation: floatUp 2s ease-out forwards;
                pointer-events: none;
            `;
            
            document.body.appendChild(float);
            
            setTimeout(() => {
                document.body.removeChild(float);
            }, 2000);
        }

        function checkAchievements() {
            const completedCount = Object.keys(AppState.lessonsCompleted).length;
            
            // First lesson achievement
            if (completedCount === 1) {
                showAchievement('🌟', 'First Steps', 'You completed your first lesson!');
            }
            
            // Streak achievements
            if (AppState.streak === 5) {
                showAchievement('🔥', 'On Fire!', '5 day learning streak!');
            }
            
            // XP milestones
            if (AppState.xp >= 1000) {
                showAchievement('⭐', 'XP Master', 'Earned 1000 XP!');
            }
        }

        function showAchievement(icon, title, description) {
            document.getElementById('achievementIcon').textContent = icon;
            document.getElementById('achievementTitle').textContent = title;
            document.getElementById('achievementDescription').textContent = description;
            
            document.getElementById('overlay').classList.add('show');
            document.getElementById('achievementPopup').classList.add('show');
        }

        function closeAchievement() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('achievementPopup').classList.remove('show');
        }

        function loadDailyChallenge() {
            const today = new Date().toDateString();
            const lastChallengeDate = localStorage.getItem('lastChallengeDate');
            
            if (lastChallengeDate !== today) {
                AppState.dailyProgress = 0;
                localStorage.setItem('dailyProgress', '0');
                localStorage.setItem('lastChallengeDate', today);
            }
            
            const challengeElement = document.getElementById('dailyChallenge');
            if (AppState.dailyProgress >= 5) {
                challengeElement.innerHTML = `
                    <div class="challenge-title">🎉 Challenge Complete!</div>
                    <div class="challenge-description">You've completed today's challenge!</div>
                    <div class="challenge-reward">Earned: +50 XP & 10 Tokens</div>
                `;
            } else {
                challengeElement.innerHTML = `
                    <div class="challenge-title">🏆 Daily Challenge</div>
                    <div class="challenge-description">Complete 5 lessons today! Progress: ${AppState.dailyProgress}/5</div>
                    <div class="challenge-reward">Reward: +50 XP & 10 Tokens</div>
                `;
            }
        }

        function loadLeaderboard() {
            // Sample leaderboard data
            const leaderboardData = [
                { name: 'Student A', score: 1250 },
                { name: 'Student B', score: 1100 },
                { name: 'Student C', score: 950 },
                { name: 'You', score: AppState.xp },
                { name: 'Student D', score: 800 }
            ];
            
            leaderboardData.sort((a, b) => b.score - a.score);
            
            const content = document.getElementById('leaderboardContent');
            content.innerHTML = leaderboardData.map((student, index) => `
                <div class="leaderboard-item ${student.name === 'You' ? 'pulse' : ''}">
                    <span class="rank">#${index + 1}</span>
                    <span>${student.name}</span>
                    <span>${student.score} XP</span>
                </div>
            `).join('');
        }

        function updateUI() {
            updateStatsDisplay();
            loadDailyChallenge();
            loadLeaderboard();
        }

        // Add CSS animation for floating points
        const style = document.createElement('style');
        style.textContent = `
            @keyframes floatUp {
                0% { opacity: 1; transform: translateX(-50%) translateY(0); }
                100% { opacity: 0; transform: translateX(-50%) translateY(-100px); }
            }
        `;
        document.head.appendChild(style);

        // Macro-Synthesis feature fully removed (JS cleanup)
        // All macro-related functions, elements, and network calls were deleted to simplify the app
        // Ensure no stray references remain; this comment marks the previous integration point.
        // ---------------------------------------------------------------
    </script>
</body>
</html>