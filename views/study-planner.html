<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Study Planner - LearnBuddy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #4c1d95 0%, #5b21b6 50%, #6d28d9 100%);
        }
        .floating-card {
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        .task-slide-in {
            animation: slideInFromLeft 0.5s ease-out;
        }
        @keyframes slideInFromLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .progress-fill {
            transition: width 0.8s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header with Navigation -->
    <nav class="gradient-bg text-white py-6 shadow-2xl relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-r from-purple-600/20 to-transparent"></div>
        <div class="container mx-auto px-6 relative z-10">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="window.location.href='/'" class="flex items-center space-x-2 hover:bg-white/10 px-4 py-2 rounded-xl transition-all duration-300">
                        <span class="text-2xl">‚Üê</span>
                        <span class="font-semibold">Back to Home</span>
                    </button>
                </div>
                <div class="text-center">
                    <h1 class="text-3xl font-bold">üìÖ Dynamic Study Planner</h1>
                    <p class="text-purple-200 mt-2">AI-Powered Personalized Scheduling</p>
                </div>
                <div class="w-32"></div> <!-- Spacer for center alignment -->
            </div>
        </div>
    </nav>

    <!-- Floating Background Elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
        <div class="floating-card absolute -left-24 top-20 w-64 h-64 bg-gradient-to-br from-blue-400/20 to-blue-600/20 rounded-full blur-3xl"></div>
        <div class="floating-card absolute -right-24 top-8 w-80 h-80 bg-gradient-to-br from-purple-400/20 to-purple-600/20 rounded-full blur-3xl" style="animation-delay: -2s;"></div>
        <div class="floating-card absolute -right-32 bottom-24 w-96 h-96 bg-gradient-to-br from-green-400/20 to-green-600/20 rounded-full blur-3xl" style="animation-delay: -4s;"></div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-16 relative z-10">
        
        <!-- Progress Overview -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
            <div class="bg-white rounded-3xl p-8 shadow-xl border border-purple-100 text-center">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 rounded-3xl flex items-center justify-center mx-auto mb-6">
                    <span class="text-white text-3xl">üìä</span>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Weekly Progress</h3>
                <div class="text-3xl font-bold text-blue-600 mb-2" id="weekly-progress">0%</div>
                <div class="w-full bg-blue-100 rounded-full h-3">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full progress-fill" id="weekly-bar" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="bg-white rounded-3xl p-8 shadow-xl border border-purple-100 text-center">
                <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-green-600 rounded-3xl flex items-center justify-center mx-auto mb-6">
                    <span class="text-white text-3xl">üî•</span>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Study Streak</h3>
                <div class="text-3xl font-bold text-green-600" id="study-streak">3 days</div>
                <div class="text-sm text-gray-600 mt-2">Keep it up!</div>
            </div>
            
            <div class="bg-white rounded-3xl p-8 shadow-xl border border-purple-100 text-center">
                <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-purple-600 rounded-3xl flex items-center justify-center mx-auto mb-6">
                    <span class="text-white text-3xl">‚è±Ô∏è</span>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Today's Goal</h3>
                <div class="text-3xl font-bold text-purple-600" id="daily-goal">2h 30m</div>
                <div class="text-sm text-gray-600 mt-2" id="time-left">1h 45m left</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-3xl p-8 shadow-xl border border-purple-100 mb-12">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üéØ Quick Actions</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <button onclick="addCustomTask()" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-2xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105">
                    <div class="text-2xl mb-2">‚ûï</div>
                    Add Task
                </button>
                
                <button onclick="generateWeeklyPlan()" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-2xl hover:from-purple-600 hover:to-purple-700 transition-all duration-300 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105">
                    <div class="text-2xl mb-2">üìÖ</div>
                    Generate Plan
                </button>
                
                <button onclick="startStudySession()" class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-2xl hover:from-green-600 hover:to-green-700 transition-all duration-300 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105">
                    <div class="text-2xl mb-2">‚ñ∂Ô∏è</div>
                    Start Session
                </button>
                
                <button onclick="viewAnalytics()" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-2xl hover:from-orange-600 hover:to-orange-700 transition-all duration-300 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105">
                    <div class="text-2xl mb-2">üìà</div>
                    Analytics
                </button>
            </div>
        </div>

        <!-- Today's Schedule -->
        <div class="bg-white rounded-3xl p-10 shadow-xl border border-purple-100 mb-12">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-2xl font-bold text-gray-800">üìù Today's Schedule</h2>
                <div class="text-right">
                    <div class="text-sm text-gray-600">Today</div>
                    <div class="font-semibold text-lg" id="current-date"></div>
                </div>
            </div>
            
            <div class="space-y-4" id="today-tasks">
                <!-- Tasks will be populated by JavaScript -->
            </div>
        </div>

        <!-- Weekly Overview -->
        <div class="bg-white rounded-3xl p-10 shadow-xl border border-purple-100">
            <h2 class="text-2xl font-bold text-gray-800 mb-8 text-center">üìÖ Weekly Overview</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-7 gap-4" id="weekly-calendar">
                <!-- Calendar will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Add New Task</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Task Name</label>
                    <input type="text" id="task-name" placeholder="e.g., Math Practice" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Subject</label>
                    <select id="task-subject" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="Math">Math</option>
                        <option value="Science">Science</option>
                        <option value="English">English</option>
                        <option value="History">History</option>
                        <option value="Geography">Geography</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Duration</label>
                    <select id="task-duration" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="15">15 minutes</option>
                        <option value="30">30 minutes</option>
                        <option value="45">45 minutes</option>
                        <option value="60">1 hour</option>
                        <option value="90">1.5 hours</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Priority</label>
                    <select id="task-priority" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
            </div>
            
            <div class="flex space-x-4 mt-8">
                <button onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-xl hover:bg-gray-400 transition-colors font-semibold">
                    Cancel
                </button>
                <button onclick="saveTask()" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all font-semibold">
                    Add Task
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // üìÖ ENHANCED DYNAMIC STUDY PLANNER WITH ADAPTIVE SCHEDULING
        
        // Study Activity Types
        const ACTIVITY_TYPES = {
            'concept-fixer': { name: 'Concept Fixer', icon: 'üß†', color: 'blue', duration: 30 },
            'doubt-buddy': { name: 'Doubt Buddy', icon: 'ü§ñ', color: 'purple', duration: 20 },
            'quiz-practice': { name: 'Quiz Practice', icon: 'üìù', color: 'green', duration: 25 },
            'language-support': { name: 'Language Support', icon: 'üåç', color: 'orange', duration: 15 },
            'knowledge-gap': { name: 'Knowledge Gap Mapper', icon: 'üéØ', color: 'red', duration: 35 }
        };

        // Subjects
        const SUBJECTS = ['Math', 'Science', 'English', 'History', 'Geography'];

        // Global State Management
        let studyState = {
            currentSession: null,
            weeklyPlan: {},
            userBehavior: {},
            progressData: {},
            streakCount: 0,
            totalStudyTime: 0,
            completedTasks: 0,
            preferredTimes: {},
            subjectPreferences: {}
        };

        // üéØ STEP 1: Initialize Personalized Study Schedule
        function initializeStudyPlanner() {
            loadUserBehaviorData();
            trackCurrentSession();
            generateAdaptivePlan();
            updateProgressDisplay();
            renderTodayTasks();
            renderWeeklyCalendar();
            setCurrentDate();
        }

        // üéØ STEP 2: Track User Behavior (Local Storage)
        function trackCurrentSession() {
            const now = new Date();
            const timeSlot = getTimeSlot(now);
            const dayOfWeek = now.toLocaleDateString('en-US', { weekday: 'long' });
            
            studyState.currentSession = {
                startTime: now.toISOString(),
                timeSlot: timeSlot,
                dayOfWeek: dayOfWeek,
                activities: []
            };

            // Track login time patterns
            if (!studyState.preferredTimes[timeSlot]) {
                studyState.preferredTimes[timeSlot] = 0;
            }
            studyState.preferredTimes[timeSlot]++;

            // Save session start
            saveUserBehaviorData();
            
            console.log(`üìä Session tracked: ${dayOfWeek} at ${timeSlot}`);
        }

        function trackActivity(activityType, subject, duration) {
            const activity = {
                type: activityType,
                subject: subject,
                duration: duration,
                timestamp: new Date().toISOString(),
                completed: false
            };

            if (studyState.currentSession) {
                studyState.currentSession.activities.push(activity);
            }
            
            // Update subject preferences
            if (!studyState.subjectPreferences[subject]) {
                studyState.subjectPreferences[subject] = 0;
            }
            studyState.subjectPreferences[subject] += duration;

            saveUserBehaviorData();
            console.log(`üìö Activity tracked: ${activityType} - ${subject} (${duration}min)`);
        }

        // üéØ STEP 3: Adaptive Plan Generation (Smart Logic)
        function generateAdaptivePlan() {
            const now = new Date();
            
            // Generate plan for today and upcoming days
            studyState.weeklyPlan = {};
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(now);
                date.setDate(date.getDate() + i);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });

                studyState.weeklyPlan[dayName] = generateDayPlan(dayName, i === 0);
            }

            console.log('üß† Adaptive plan generated based on user behavior');
        }

        function generateDayPlan(dayName, isToday) {
            const preferredTime = getMostPreferredTime() || '17:00';
            const preferredSubjects = getTopPreferredSubjects();
            
            const plans = [];
            const sessionCount = isToday ? 3 : Math.floor(Math.random() * 2) + 2;
            
            for (let i = 0; i < sessionCount; i++) {
                const startTime = calculateSessionTime(preferredTime, i);
                const activity = selectOptimalActivity(dayName, i, preferredSubjects);
                const duration = ACTIVITY_TYPES[activity.type].duration;
                
                plans.push({
                    id: `${dayName}-${i}`,
                    name: `${ACTIVITY_TYPES[activity.type].name}: ${activity.subject}`,
                    subject: activity.subject,
                    time: `${startTime} - ${addMinutes(startTime, duration)}`,
                    duration: duration,
                    completed: false,
                    priority: i === 0 ? 'High' : i === 1 ? 'Medium' : 'Low',
                    day: dayName,
                    activityType: activity.type,
                    recommended: true
                });
            }

            return plans;
        }

        function selectOptimalActivity(dayName, sessionIndex, preferredSubjects) {
            const activityTypes = Object.keys(ACTIVITY_TYPES);
            let selectedType, selectedSubject;

            // Smart activity selection based on user behavior
            if (sessionIndex === 0) {
                selectedType = 'knowledge-gap'; // Start with gap analysis
            } else if (sessionIndex === 1) {
                selectedType = Math.random() > 0.5 ? 'concept-fixer' : 'quiz-practice';
            } else {
                selectedType = Math.random() > 0.5 ? 'doubt-buddy' : 'language-support';
            }

            // Select subject based on preferences
            if (preferredSubjects.length > 0) {
                selectedSubject = preferredSubjects[sessionIndex % preferredSubjects.length];
            } else {
                selectedSubject = SUBJECTS[Math.floor(Math.random() * SUBJECTS.length)];
            }

            return { type: selectedType, subject: selectedSubject };
        }

        // üéØ STEP 4: Progress Tracking System
        function toggleTask(taskId) {
            // Find the task in weekly plan
            let task = null;
            Object.values(studyState.weeklyPlan).forEach(dayTasks => {
                const foundTask = dayTasks.find(t => t.id === taskId);
                if (foundTask) task = foundTask;
            });

            if (task) {
                task.completed = !task.completed;
                
                if (task.completed) {
                    // Update progress stats
                    studyState.completedTasks++;
                    studyState.totalStudyTime += task.duration;
                    studyState.streakCount++;
                    
                    // Track the completed activity
                    trackActivity(task.activityType, task.subject, task.duration);
                    
                    // Show celebration
                    showCompletionCelebration(task);
                } else {
                    studyState.completedTasks = Math.max(0, studyState.completedTasks - 1);
                    studyState.totalStudyTime = Math.max(0, studyState.totalStudyTime - task.duration);
                }
                
                // Update displays
                updateProgressDisplay();
                renderTodayTasks();
                renderWeeklyCalendar();
                saveUserBehaviorData();
                
                if (task.completed) {
                    suggestNextTask();
                }
            }
        }

        function showCompletionCelebration(task) {
            const celebration = document.createElement('div');
            celebration.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="this.remove()">
                    <div class="bg-white rounded-3xl p-8 max-w-md mx-4 text-center animate-bounce">
                        <div class="text-6xl mb-4">üéâ</div>
                        <h3 class="text-2xl font-bold text-green-600 mb-2">Task Completed!</h3>
                        <p class="text-gray-600 mb-4">You completed ${task.name}!</p>
                        <div class="bg-green-100 p-4 rounded-lg mb-4">
                            <p class="text-green-800">+${task.duration} minutes study time</p>
                            <p class="text-green-800">Streak: ${studyState.streakCount} tasks! üî•</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            Keep Learning! ‚Üí
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(celebration);
        }

        function suggestNextTask() {
            const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            const todayTasks = studyState.weeklyPlan[today] || [];
            const nextTask = todayTasks.find(task => !task.completed);
            
            if (nextTask) {
                const suggestion = document.createElement('div');
                suggestion.innerHTML = `
                    <div class="fixed bottom-4 right-4 bg-blue-500 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm">
                        <h4 class="font-bold mb-2">üéØ Next Recommended:</h4>
                        <p class="text-sm mb-3">${nextTask.name}</p>
                        <div class="flex space-x-2">
                            <button onclick="toggleTask('${nextTask.id}'); this.parentElement.parentElement.parentElement.remove();" 
                                    class="bg-white text-blue-500 px-3 py-1 rounded text-sm hover:bg-gray-100">
                                Start Now
                            </button>
                            <button onclick="this.parentElement.parentElement.parentElement.remove();" 
                                    class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                Later
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(suggestion);
                
                setTimeout(() => {
                    if (suggestion.parentNode) {
                        suggestion.remove();
                    }
                }, 8000);
            }
        }

        // üéØ STEP 5: User-Friendly Display System
        function renderTodayTasks() {
            const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            const todayTasks = studyState.weeklyPlan[today] || [];
            const container = document.getElementById('today-tasks');
            
            container.innerHTML = todayTasks.map(task => `
                <div class="study-task bg-gray-50 border border-gray-200 rounded-2xl p-6 task-slide-in ${task.completed ? 'bg-green-50 border-green-200' : ''}" data-task="${task.id}">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-${getSubjectColor(task.subject)}-500 to-${getSubjectColor(task.subject)}-600 rounded-xl flex items-center justify-center">
                                <span class="text-white text-lg">${getSubjectEmoji(task.subject)}</span>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-800">${task.name}</div>
                                <div class="text-gray-600 text-sm">${task.time} ‚Ä¢ ${task.duration} min ‚Ä¢ ${task.priority} Priority</div>
                                ${task.recommended ? '<div class="text-purple-600 text-xs font-medium">üìç AI Recommended</div>' : ''}
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${getPriorityColor(task.priority)}">${task.priority}</span>
                            <button onclick="toggleTask('${task.id}')" class="px-4 py-2 rounded-xl text-sm font-semibold transition-all duration-300 ${task.completed ? 'bg-green-500 text-white' : 'bg-blue-500 text-white hover:bg-blue-600'}">
                                ${task.completed ? '‚úì Done' : 'Mark Done'}
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderWeeklyCalendar() {
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const fullDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const container = document.getElementById('weekly-calendar');
            
            container.innerHTML = days.map((day, index) => {
                const fullDay = fullDays[index];
                const dayTasks = studyState.weeklyPlan[fullDay] || [];
                const completed = dayTasks.filter(t => t.completed).length;
                const total = dayTasks.length;
                const progress = total > 0 ? (completed / total) * 100 : 0;
                
                return `
                    <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200">
                        <div class="text-center mb-3">
                            <div class="font-bold text-gray-800">${day}</div>
                            <div class="text-xs text-gray-600">${total} tasks</div>
                        </div>
                        <div class="space-y-2">
                            ${dayTasks.slice(0, 2).map(task => `
                                <div class="text-xs p-2 rounded-lg ${task.completed ? 'bg-green-100 text-green-800' : 'bg-white border'}">
                                    ${ACTIVITY_TYPES[task.activityType]?.icon || 'üìö'} ${task.subject}
                                </div>
                            `).join('')}
                            ${dayTasks.length > 2 ? `<div class="text-xs text-gray-500 text-center">+${dayTasks.length - 2} more</div>` : ''}
                        </div>
                        <div class="mt-3">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full progress-fill" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateProgressDisplay() {
            // Calculate total tasks and completed across all days
            let totalTasks = 0;
            let completedTasks = 0;
            
            Object.values(studyState.weeklyPlan).forEach(dayTasks => {
                totalTasks += dayTasks.length;
                completedTasks += dayTasks.filter(t => t.completed).length;
            });
            
            const weeklyProgress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            document.getElementById('weekly-progress').textContent = weeklyProgress + '%';
            document.getElementById('weekly-bar').style.width = weeklyProgress + '%';
            
            // Update other stats if elements exist
            const completedElement = document.getElementById('completed-tasks');
            const streakElement = document.getElementById('study-streak');
            const timeElement = document.getElementById('total-time');
            
            if (completedElement) completedElement.textContent = studyState.completedTasks;
            if (streakElement) streakElement.textContent = studyState.streakCount;
            if (timeElement) timeElement.textContent = studyState.totalStudyTime;
        }

        // Utility Functions
        function getTimeSlot(date) {
            const hour = date.getHours();
            if (hour < 12) return 'morning';
            if (hour < 17) return 'afternoon';
            return 'evening';
        }

        function getMostPreferredTime() {
            const times = studyState.preferredTimes;
            let maxCount = 0;
            let preferredSlot = 'evening';
            
            Object.entries(times).forEach(([slot, count]) => {
                if (count > maxCount) {
                    maxCount = count;
                    preferredSlot = slot;
                }
            });
            
            const timeMap = {
                'morning': '09:00',
                'afternoon': '14:00',
                'evening': '17:00'
            };
            
            return timeMap[preferredSlot] || '17:00';
        }

        function getTopPreferredSubjects() {
            return Object.entries(studyState.subjectPreferences)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3)
                .map(([subject]) => subject);
        }

        function calculateSessionTime(baseTime, sessionIndex) {
            const [hours, minutes] = baseTime.split(':').map(Number);
            const sessionStart = new Date();
            sessionStart.setHours(hours + sessionIndex, minutes, 0, 0);
            
            return sessionStart.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
        }

        function addMinutes(timeString, minutes) {
            const [hours, mins] = timeString.split(':').map(Number);
            const date = new Date();
            date.setHours(hours, mins + minutes, 0, 0);
            
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
        }

        function getSubjectColor(subject) {
            const colors = {
                'Math': 'blue',
                'Science': 'green',
                'English': 'purple',
                'History': 'orange',
                'Geography': 'indigo'
            };
            return colors[subject] || 'gray';
        }
        
        function getSubjectEmoji(subject) {
            const emojis = {
                'Math': 'üî¢',
                'Science': 'üß™',
                'English': 'üìö',
                'History': 'üèõÔ∏è',
                'Geography': 'üåç'
            };
            return emojis[subject] || 'üìñ';
        }
        
        function getPriorityColor(priority) {
            const colors = {
                'High': 'bg-red-100 text-red-800',
                'Medium': 'bg-yellow-100 text-yellow-800',
                'Low': 'bg-green-100 text-green-800'
            };
            return colors[priority] || 'bg-gray-100 text-gray-800';
        }

        function setCurrentDate() {
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = today.toLocaleDateString('en-US', options);
        }

        // Data Persistence
        function saveUserBehaviorData() {
            try {
                localStorage.setItem('learnit-study-planner', JSON.stringify(studyState));
                console.log('üíæ Study planner data saved');
            } catch (error) {
                console.warn('Could not save study planner data:', error);
            }
        }

        function loadUserBehaviorData() {
            try {
                const saved = localStorage.getItem('learnit-study-planner');
                if (saved) {
                    const parsedData = JSON.parse(saved);
                    studyState = { ...studyState, ...parsedData };
                    console.log('üìñ Study planner data loaded');
                }
            } catch (error) {
                console.warn('Could not load study planner data:', error);
            }
        }

        // Smart Plan Functions
        function generateWeeklyPlan() {
            generateAdaptivePlan();
            renderTodayTasks();
            renderWeeklyCalendar();
            updateProgressDisplay();
            
            alert('üß† Smart Weekly Plan Generated!\n\n' +
                  'Based on your study behavior:\n' +
                  `‚Ä¢ Preferred study time: ${getMostPreferredTime()}\n` +
                  `‚Ä¢ Top subjects: ${getTopPreferredSubjects().slice(0, 2).join(', ')}\n` +
                  `‚Ä¢ Total study time: ${studyState.totalStudyTime} minutes\n` +
                  `‚Ä¢ Current streak: ${studyState.streakCount} tasks\n\n` +
                  'Your plan adapts to your learning patterns! üéØ');
        }

        function startStudySession() {
            const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            const todayTasks = studyState.weeklyPlan[today] || [];
            const nextTask = todayTasks.find(task => !task.completed);
            
            if (nextTask) {
                alert(`üéØ Study Session Started!\n\n` +
                      `Current Task: ${nextTask.name}\n` +
                      `Duration: ${nextTask.duration} minutes\n` +
                      `Subject: ${nextTask.subject}\n` +
                      `Priority: ${nextTask.priority}\n\n` +
                      `üéµ Focus mode: Enabled\n` +
                      `üì± Distractions: Blocked\n\n` +
                      `Good luck with your studies! üåü`);
                
                // Auto-mark as completed after a delay (for demo)
                setTimeout(() => {
                    if (confirm('Mark this session as completed?')) {
                        toggleTask(nextTask.id);
                    }
                }, 5000);
            } else {
                alert('üéâ All tasks for today are completed!\n\nGreat job! Consider reviewing previous topics or preparing for tomorrow.');
            }
        }

        function viewAnalytics() {
            const topSubject = getTopPreferredSubjects()[0] || 'Math';
            const preferredTime = getMostPreferredTime();
            const timeSlot = preferredTime < '12:00' ? 'Morning' : preferredTime < '17:00' ? 'Afternoon' : 'Evening';
            
            alert('üìà Study Analytics\n\n' +
                  'üìä Your Learning Profile:\n' +
                  `‚Ä¢ Total study time: ${studyState.totalStudyTime} minutes\n` +
                  `‚Ä¢ Tasks completed: ${studyState.completedTasks}\n` +
                  `‚Ä¢ Current streak: ${studyState.streakCount} tasks\n` +
                  `‚Ä¢ Favorite subject: ${topSubject}\n` +
                  `‚Ä¢ Preferred time: ${timeSlot}\n\n` +
                  'üéØ AI Insights:\n' +
                  '‚Ä¢ Your consistency is improving\n' +
                  '‚Ä¢ Math sessions show strong focus\n' +
                  `‚Ä¢ ${timeSlot} study sessions are most productive\n\n` +
                  'Keep up the excellent work! üèÜ');
        }

        // Modal Functions
        function addCustomTask() {
            document.getElementById('task-modal').classList.remove('hidden');
        }
        
        function closeModal() {
            document.getElementById('task-modal').classList.add('hidden');
        }
        
        function saveTask() {
            const name = document.getElementById('task-name').value;
            const subject = document.getElementById('task-subject').value;
            const duration = parseInt(document.getElementById('task-duration').value);
            const priority = document.getElementById('task-priority').value;
            
            if (name.trim()) {
                const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
                const newTask = {
                    id: `custom-${Date.now()}`,
                    name: name.trim(),
                    subject: subject,
                    time: 'Custom Time',
                    duration: duration,
                    completed: false,
                    priority: priority,
                    day: today,
                    activityType: 'concept-fixer',
                    recommended: false
                };
                
                if (!studyState.weeklyPlan[today]) {
                    studyState.weeklyPlan[today] = [];
                }
                studyState.weeklyPlan[today].push(newTask);
                
                updateProgressDisplay();
                renderTodayTasks();
                renderWeeklyCalendar();
                saveUserBehaviorData();
                closeModal();
                
                // Clear form
                document.getElementById('task-name').value = '';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Dynamic Study Planner with Adaptive Scheduling initialized');
            initializeStudyPlanner();
        });
    </script>
</body>
</html>