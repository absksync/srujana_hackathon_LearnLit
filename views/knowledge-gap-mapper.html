<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Gap Mapper - LearnIt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #4c1d95 0%, #5b21b6 50%, #6d28d9 100%);
        }
        .floating-card {
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        .question-appear {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .feedback-appear {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header with Navigation -->
    <nav class="gradient-bg text-white py-6 shadow-2xl relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-r from-purple-600/20 to-transparent"></div>
        <div class="container mx-auto px-6 relative z-10">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="window.location.href='/'" class="flex items-center space-x-2 hover:bg-white/10 px-4 py-2 rounded-xl transition-all duration-300">
                        <span class="text-2xl">‚Üê</span>
                        <span class="font-semibold">Back to Home</span>
                    </button>
                </div>
                <div class="text-center">
                    <h1 class="text-3xl font-bold">üéØ Knowledge Gap Mapper</h1>
                    <p class="text-purple-200 mt-2">AI-Powered Learning Assessment</p>
                </div>
                <div class="w-32"></div> <!-- Spacer for center alignment -->
            </div>
        </div>
    </nav>

    <!-- Floating Background Elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
        <div class="floating-card absolute -left-24 top-20 w-64 h-64 bg-gradient-to-br from-red-400/20 to-red-600/20 rounded-full blur-3xl"></div>
        <div class="floating-card absolute -right-24 top-8 w-80 h-80 bg-gradient-to-br from-purple-400/20 to-purple-600/20 rounded-full blur-3xl" style="animation-delay: -2s;"></div>
        <div class="floating-card absolute -right-32 bottom-24 w-96 h-96 bg-gradient-to-br from-blue-400/20 to-blue-600/20 rounded-full blur-3xl" style="animation-delay: -4s;"></div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-16 relative z-10">
        
        <!-- Progress Overview -->
        <div class="bg-white rounded-3xl p-8 shadow-xl border border-purple-100 mb-12">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Your Learning Progress</h2>
                <div class="text-right">
                    <div class="text-3xl font-bold text-red-600" id="score">0/0</div>
                    <div class="text-sm text-gray-600">Questions Correct</div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-red-50 border border-red-200 rounded-2xl p-6 text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-red-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <span class="text-white text-2xl">üìä</span>
                    </div>
                    <h3 class="font-bold text-red-800 mb-2">Accuracy Rate</h3>
                    <div class="text-2xl font-bold text-red-600" id="accuracy">0%</div>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-2xl p-6 text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <span class="text-white text-2xl">‚≠ê</span>
                    </div>
                    <h3 class="font-bold text-blue-800 mb-2">Streak</h3>
                    <div class="text-2xl font-bold text-blue-600" id="streak">0</div>
                </div>
                
                <div class="bg-purple-50 border border-purple-200 rounded-2xl p-6 text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <span class="text-white text-2xl">üéØ</span>
                    </div>
                    <h3 class="font-bold text-purple-800 mb-2">Level</h3>
                    <div class="text-2xl font-bold text-purple-600" id="level">Beginner</div>
                </div>
            </div>
        </div>

        <!-- Question Area -->
        <div class="bg-white rounded-3xl p-10 shadow-xl border border-purple-100 mb-8">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Solve This Problem</h2>
                <div class="w-20 h-1 bg-gradient-to-r from-red-500 to-red-600 mx-auto rounded-full"></div>
            </div>
            
            <div class="max-w-2xl mx-auto">
                <div class="bg-gray-50 rounded-3xl p-8 mb-6 question-appear" id="question-container">
                    <div class="text-center mb-6">
                        <div class="text-lg font-semibold text-gray-600 mb-2">Question <span id="question-number">1</span></div>
                        <h3 class="text-3xl font-bold text-gray-800 mb-4" id="current-question">Solve: 3x + 2 = 8</h3>
                        <div class="text-gray-600" id="question-hint">Find the value of x</div>
                    </div>
                    
                    <div class="space-y-4">
                        <input type="text" id="gap-answer" placeholder="Enter your answer..." 
                               class="w-full border-2 border-gray-300 rounded-2xl px-6 py-4 text-lg text-center focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all duration-300">
                        
                        <div class="flex items-center justify-between">
                            <div class="flex space-x-2" id="attempt-dots">
                                <div class="w-4 h-4 bg-gray-200 rounded-full transition-all duration-300"></div>
                                <div class="w-4 h-4 bg-gray-200 rounded-full transition-all duration-300"></div>
                                <div class="w-4 h-4 bg-gray-200 rounded-full transition-all duration-300"></div>
                            </div>
                            <button onclick="checkGapAnswer()" 
                                    class="bg-gradient-to-r from-red-500 to-red-600 text-white px-8 py-3 rounded-2xl hover:from-red-600 hover:to-red-700 transition-all duration-300 font-semibold text-lg shadow-lg hover:shadow-xl transform hover:scale-105">
                                Submit Answer
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Feedback Area -->
                <div id="gap-feedback" class="hidden feedback-appear"></div>
            </div>
        </div>

        <!-- Knowledge Gaps Identified -->
        <div class="bg-white rounded-3xl p-10 shadow-xl border border-purple-100">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üìà Knowledge Gaps Identified</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="knowledge-gaps">
                <div class="bg-orange-50 border border-orange-200 rounded-2xl p-6">
                    <h3 class="font-bold text-orange-800 mb-3">‚ö†Ô∏è Needs Practice</h3>
                    <ul class="space-y-2 text-orange-700" id="needs-practice">
                        <li class="flex items-center"><span class="w-2 h-2 bg-orange-400 rounded-full mr-3"></span>Complete your first question to see gaps</li>
                    </ul>
                </div>
                
                <div class="bg-green-50 border border-green-200 rounded-2xl p-6">
                    <h3 class="font-bold text-green-800 mb-3">‚úÖ Mastered Topics</h3>
                    <ul class="space-y-2 text-green-700" id="mastered-topics">
                        <li class="flex items-center"><span class="w-2 h-2 bg-green-400 rounded-full mr-3"></span>Start solving to track mastery</li>
                    </ul>
                </div>
            </div>
            
            <div class="mt-8 text-center">
                <button onclick="generateStudyPlan()" 
                        class="bg-gradient-to-r from-purple-600 to-purple-700 text-white px-8 py-3 rounded-2xl hover:from-purple-700 hover:to-purple-800 transition-all duration-300 font-semibold text-lg shadow-lg hover:shadow-xl transform hover:scale-105">
                    üéØ Generate Personalized Study Plan
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // üéØ Enhanced AI-Powered Knowledge Gap Mapper with 5-Step Intelligent Analysis
        
        // Game State Management
        let gameState = {
            currentQuestionIndex: 0,
            currentSubject: 'algebra',
            stars: 0,
            streak: 0,
            weaknessAreas: {},
            masteredConcepts: [],
            currentAttempt: 1,
            showingFollowUp: false,
            totalCorrect: 0,
            totalAnswered: 0
        };

        // Enhanced Question Database with Step-by-Step Analysis
        const questionDatabase = {
            algebra: [
                {
                    id: 1,
                    question: "Solve for x: 2x + 3 = 7",
                    correctAnswer: "x = 2",
                    alternateAnswers: ["2", "x=2", "X=2", "X = 2"],
                    steps: [
                        { step: "Start with: 2x + 3 = 7", highlight: "original" },
                        { step: "Subtract 3 from both sides: 2x = 4", highlight: "subtract" }, 
                        { step: "Divide both sides by 2: x = 2", highlight: "divide" }
                    ],
                    commonMistakes: {
                        "5": {
                            error: "You forgot to subtract 3 before dividing by 2",
                            weakness: "Order of Operations",
                            hint: "Remember: Always isolate the variable term first by undoing addition/subtraction, then handle multiplication/division",
                            targetedFix: "You calculated 7 √∑ 2 = 3.5, but forgot to subtract 3 first! Let's fix this step by step..."
                        },
                        "1": {
                            error: "Oops! Check your addition step again",
                            weakness: "Basic Arithmetic",
                            hint: "When you have 2x + 3 = 7, you need to subtract 3 from both sides first",
                            targetedFix: "You're close! Let's review the subtraction step carefully..."
                        },
                        "10": {
                            error: "You added instead of subtracting",
                            weakness: "Sign Operations",
                            hint: "To eliminate +3, you need to do the opposite operation: subtract 3",
                            targetedFix: "Think about inverse operations - if we see +3, we need to subtract 3..."
                        }
                    },
                    followUpQuestion: {
                        question: "Now try solving: 3x + 5 = 14",
                        correctAnswer: "x = 3",
                        alternateAnswers: ["3", "x=3", "X=3", "X = 3"],
                        steps: [
                            { step: "Start with: 3x + 5 = 14", highlight: "original" },
                            { step: "Subtract 5 from both sides: 3x = 9", highlight: "subtract" },
                            { step: "Divide both sides by 3: x = 3", highlight: "divide" }
                        ]
                    }
                },
                {
                    id: 2,
                    question: "Solve for x: 3x + 5 = 14",
                    correctAnswer: "x = 3",
                    alternateAnswers: ["3", "x=3", "X=3", "X = 3"],
                    steps: [
                        { step: "Start with: 3x + 5 = 14", highlight: "original" },
                        { step: "Subtract 5 from both sides: 3x = 9", highlight: "subtract" },
                        { step: "Divide both sides by 3: x = 3", highlight: "divide" }
                    ],
                    commonMistakes: {
                        "6": {
                            error: "You divided before subtracting",
                            weakness: "Order of Operations",
                            hint: "Always handle addition/subtraction before multiplication/division",
                            targetedFix: "You tried to divide 14 by 3 first! Let's follow the correct order..."
                        },
                        "19": {
                            error: "You added 5 instead of subtracting it",
                            weakness: "Inverse Operations",
                            hint: "To eliminate +5, you subtract 5 from both sides",
                            targetedFix: "Remember: do the opposite of what you see. If you see +5, you subtract 5..."
                        }
                    },
                    followUpQuestion: {
                        question: "Great! Now try: 4x - 8 = 12",
                        correctAnswer: "x = 5",
                        alternateAnswers: ["5", "x=5", "X=5", "X = 5"],
                        steps: [
                            { step: "Start with: 4x - 8 = 12", highlight: "original" },
                            { step: "Add 8 to both sides: 4x = 20", highlight: "add" },
                            { step: "Divide both sides by 4: x = 5", highlight: "divide" }
                        ]
                    }
                },
                {
                    id: 3,
                    question: "Solve for x: 4x - 8 = 12",
                    correctAnswer: "x = 5",
                    alternateAnswers: ["5", "x=5", "X=5", "X = 5"],
                    steps: [
                        { step: "Start with: 4x - 8 = 12", highlight: "original" },
                        { step: "Add 8 to both sides: 4x = 20", highlight: "add" },
                        { step: "Divide both sides by 4: x = 5", highlight: "divide" }
                    ],
                    commonMistakes: {
                        "1": {
                            error: "You subtracted 8 instead of adding it",
                            weakness: "Sign Operations",
                            hint: "To eliminate -8, you need to add 8 to both sides",
                            targetedFix: "When you see subtraction, add to cancel it out. -8 + 8 = 0"
                        },
                        "3": {
                            error: "Check your division step",
                            weakness: "Basic Arithmetic",
                            hint: "20 √∑ 4 = 5, not 3",
                            targetedFix: "Let's review basic division: 20 √∑ 4 = ?"
                        }
                    },
                    followUpQuestion: {
                        question: "Excellent! Try this: 5x + 2 = 17",
                        correctAnswer: "x = 3",
                        alternateAnswers: ["3", "x=3", "X=3", "X = 3"],
                        steps: [
                            { step: "Start with: 5x + 2 = 17", highlight: "original" },
                            { step: "Subtract 2 from both sides: 5x = 15", highlight: "subtract" },
                            { step: "Divide both sides by 5: x = 3", highlight: "divide" }
                        ]
                    }
                }
            ]
        };

        // üéØ STEP 1: Initialize Question Display
        function initializeQuestion() {
            gameState.currentQuestionIndex = 0;
            gameState.showingFollowUp = false;
            loadQuestion();
            updateProgressDisplay();
        }

        // Load current question
        function loadQuestion() {
            const questions = questionDatabase[gameState.currentSubject];
            const currentQ = questions[gameState.currentQuestionIndex];
            
            if (gameState.showingFollowUp && currentQ.followUpQuestion) {
                document.getElementById('current-question').textContent = currentQ.followUpQuestion.question;
            } else {
                document.getElementById('current-question').textContent = currentQ.question;
            }
            
            document.getElementById('gap-answer').value = '';
            document.getElementById('gap-feedback').innerHTML = '';
            document.getElementById('gap-feedback').classList.add('hidden');
            
            // Reset attempt dots
            const dots = document.getElementById('attempt-dots').children;
            for (let i = 0; i < dots.length; i++) {
                dots[i].classList.remove('bg-red-400', 'bg-green-400');
                dots[i].classList.add('bg-gray-200');
            }
            
            updateProgressDisplay();
        }

        // üéØ STEP 2: Intelligent Gap Analysis (Enhanced AI Simulation)
        function checkGapAnswer() {
            const studentAnswer = document.getElementById('gap-answer').value.trim();
            const questions = questionDatabase[gameState.currentSubject];
            const currentQ = questions[gameState.currentQuestionIndex];
            
            let questionData, correctAnswers;
            
            if (gameState.showingFollowUp && currentQ.followUpQuestion) {
                questionData = currentQ.followUpQuestion;
                correctAnswers = [currentQ.followUpQuestion.correctAnswer.toLowerCase(), ...currentQ.followUpQuestion.alternateAnswers.map(a => a.toLowerCase())];
            } else {
                questionData = currentQ;
                correctAnswers = [currentQ.correctAnswer.toLowerCase(), ...currentQ.alternateAnswers.map(a => a.toLowerCase())];
            }

            // Update attempt indicator
            const dots = document.getElementById('attempt-dots').children;
            if (gameState.currentAttempt <= 3) {
                dots[gameState.currentAttempt - 1].classList.remove('bg-gray-200');
            }

            // ‚úÖ Check if answer is correct
            if (correctAnswers.includes(studentAnswer.toLowerCase())) {
                showCorrectFeedback();
                return;
            }

            // üîç Analyze common mistakes (Smart Detection)
            if (!gameState.showingFollowUp && currentQ.commonMistakes[studentAnswer]) {
                const mistake = currentQ.commonMistakes[studentAnswer];
                showIntelligentFeedback(mistake, currentQ);
                trackWeakness(mistake.weakness);
                return;
            }

            // Generic wrong answer
            showGenericIncorrectFeedback();
        }

        // üéØ STEP 3: Step-by-Step Targeted Fix
        function showStepByStepFix(questionData, mistakeInfo = null) {
            setTimeout(() => {
                const stepContainer = document.getElementById('gap-feedback');
                
                let stepsHTML = `
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-6 rounded-lg mt-4">
                        <div class="flex items-center mb-4">
                            <span class="text-3xl mr-3">üìù</span>
                            <h3 class="text-xl font-bold text-blue-800">Here's exactly where you went wrong...</h3>
                        </div>
                        ${mistakeInfo ? `
                        <div class="bg-red-100 p-4 rounded-lg mb-4 border border-red-300">
                            <p class="text-red-800 font-semibold">‚ùå Your mistake: ${mistakeInfo.targetedFix}</p>
                        </div>
                        ` : ''}
                        <div class="space-y-3">
                            <h4 class="font-bold text-blue-800 mb-3">üìö Correct solution:</h4>
                `;
                
                questionData.steps.forEach((stepObj, index) => {
                    const colorClass = stepObj.highlight === 'original' ? 'border-gray-300 bg-gray-50' :
                                     stepObj.highlight === 'subtract' ? 'border-red-300 bg-red-50' :
                                     stepObj.highlight === 'add' ? 'border-green-300 bg-green-50' :
                                     stepObj.highlight === 'divide' ? 'border-blue-300 bg-blue-50' :
                                     'border-purple-300 bg-purple-50';
                    
                    stepsHTML += `
                        <div class="flex items-start space-x-3 p-4 ${colorClass} rounded-lg border-2">
                            <span class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">${index + 1}</span>
                            <p class="text-blue-800 font-medium flex-1">${stepObj.step}</p>
                        </div>
                    `;
                });
                
                stepsHTML += `
                        </div>
                        <div class="mt-6 flex space-x-4 justify-center">
                            <button onclick="retryQuestion()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors font-semibold shadow-lg transform hover:scale-105">
                                üîÑ Try Again
                            </button>
                            <button onclick="showHint()" class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition-colors font-semibold shadow-lg transform hover:scale-105">
                                üí° Get Hint
                            </button>
                        </div>
                    </div>
                `;
                
                stepContainer.innerHTML += stepsHTML;
            }, 1500);
        }

        // üéØ STEP 4: Gamified Progress Feedback
        function showCorrectFeedback() {
            const feedbackContainer = document.getElementById('gap-feedback');
            const starsEarned = Math.max(1, 4 - gameState.currentAttempt);
            
            gameState.stars += starsEarned;
            gameState.streak++;
            gameState.totalCorrect++;
            gameState.totalAnswered++;
            
            // Update visual feedback
            const dots = document.getElementById('attempt-dots').children;
            if (gameState.currentAttempt <= 3) {
                dots[gameState.currentAttempt - 1].classList.add('bg-green-400');
            }
            
            feedbackContainer.innerHTML = `
                <div class="bg-green-50 border-l-4 border-green-400 p-6 rounded-lg animate-bounce">
                    <div class="flex items-center mb-4">
                        <span class="text-4xl mr-3 animate-pulse">üéâ</span>
                        <h3 class="text-2xl font-bold text-green-800">Great job! You earned ${starsEarned} stars!</h3>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg mb-4">
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <p class="text-green-800 font-bold text-2xl">${gameState.stars} ‚≠ê</p>
                                <p class="text-green-600 text-sm">Total Stars</p>
                            </div>
                            <div>
                                <p class="text-green-800 font-bold text-2xl">${gameState.streak} üî•</p>
                                <p class="text-green-600 text-sm">Streak</p>
                            </div>
                            <div>
                                <p class="text-green-800 font-bold text-2xl">${Math.round((gameState.totalCorrect / gameState.totalAnswered) * 100)}%</p>
                                <p class="text-green-600 text-sm">Accuracy</p>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="inline-flex items-center bg-yellow-100 px-4 py-2 rounded-full">
                            <span class="text-yellow-600 font-semibold">Concept Mastery Map Progressed! üìà</span>
                        </div>
                    </div>
                </div>
            `;
            
            feedbackContainer.classList.remove('hidden');
            
            // üéØ STEP 5: Follow-Up Practice Question
            setTimeout(() => {
                if (!gameState.showingFollowUp) {
                    showFollowUpQuestion();
                } else {
                    nextQuestion();
                }
            }, 3000);
        }

        // Show intelligent feedback for wrong answers
        function showIntelligentFeedback(mistake, questionData) {
            const feedbackContainer = document.getElementById('gap-feedback');
            
            // Update visual feedback
            const dots = document.getElementById('attempt-dots').children;
            if (gameState.currentAttempt <= 3) {
                dots[gameState.currentAttempt - 1].classList.add('bg-red-400');
            }
            
            feedbackContainer.innerHTML = `
                <div class="bg-red-50 border-l-4 border-red-400 p-6 rounded-lg">
                    <div class="flex items-center mb-4">
                        <span class="text-3xl mr-3">ü§î</span>
                        <h3 class="text-xl font-bold text-red-800">Let's fix this together!</h3>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-red-100 p-4 rounded-lg border border-red-300">
                            <p class="text-red-800"><strong>‚ùå Issue Detected:</strong> ${mistake.error}</p>
                            <p class="text-red-700 mt-2"><strong>üéØ Weakness Area:</strong> ${mistake.weakness}</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <p class="text-blue-800"><strong>üí° Targeted Hint:</strong> ${mistake.hint}</p>
                        </div>
                    </div>
                </div>
            `;
            
            feedbackContainer.classList.remove('hidden');
            gameState.currentAttempt++;
            gameState.totalAnswered++;
            
            // Show step-by-step explanation
            showStepByStepFix(questionData, mistake);
        }

        // üéØ STEP 5: Follow-Up Practice Question
        function showFollowUpQuestion() {
            const questions = questionDatabase[gameState.currentSubject];
            const currentQ = questions[gameState.currentQuestionIndex];
            
            if (currentQ.followUpQuestion) {
                const followUpHTML = `
                    <div class="bg-purple-50 border-l-4 border-purple-400 p-6 rounded-lg mt-4">
                        <div class="flex items-center mb-4">
                            <span class="text-3xl mr-3">üöÄ</span>
                            <h3 class="text-xl font-bold text-purple-800">Follow-Up Practice</h3>
                        </div>
                        <p class="text-purple-700 mb-4">Excellent work! Now let's practice with a similar problem to reinforce your understanding:</p>
                        <div class="bg-white p-4 rounded-lg border border-purple-200 shadow-sm">
                            <p class="text-lg font-semibold text-gray-800 mb-4">${currentQ.followUpQuestion.question}</p>
                            <button onclick="startFollowUp()" class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition-colors font-semibold shadow-lg transform hover:scale-105">
                                üéØ Start Practice
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('gap-feedback').innerHTML += followUpHTML;
            } else {
                setTimeout(nextQuestion, 2000);
            }
        }

        // Start follow-up question
        function startFollowUp() {
            gameState.showingFollowUp = true;
            gameState.currentAttempt = 1;
            loadQuestion();
        }

        // Track weakness areas
        function trackWeakness(weaknessArea) {
            if (!gameState.weaknessAreas[weaknessArea]) {
                gameState.weaknessAreas[weaknessArea] = 0;
            }
            gameState.weaknessAreas[weaknessArea]++;
            updateWeaknessDisplay();
        }

        // Update weakness display
        function updateWeaknessDisplay() {
            const weaknessContainer = document.getElementById('needs-practice');
            
            if (Object.keys(gameState.weaknessAreas).length === 0) {
                weaknessContainer.innerHTML = '<li class="flex items-center"><span class="w-2 h-2 bg-orange-400 rounded-full mr-3"></span>Complete your first question to see gaps</li>';
                return;
            }
            
            let weaknessHTML = '';
            Object.entries(gameState.weaknessAreas).forEach(([area, count]) => {
                const intensity = count > 2 ? 'high' : count > 1 ? 'medium' : 'low';
                const colorClass = intensity === 'high' ? 'bg-red-100 text-red-800 border-red-300' : 
                                 intensity === 'medium' ? 'bg-yellow-100 text-yellow-800 border-yellow-300' : 
                                 'bg-orange-100 text-orange-800 border-orange-300';
                
                weaknessHTML += `
                    <li class="border-2 ${colorClass} rounded-lg p-3 mb-2">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">${area}</span>
                            <span class="text-xs px-2 py-1 bg-white rounded-full">‚ùå ${count}</span>
                        </div>
                        <p class="text-xs mt-1 opacity-75">Practice more problems involving this concept</p>
                    </li>
                `;
            });
            
            weaknessContainer.innerHTML = weaknessHTML;
        }

        // Update progress display
        function updateProgressDisplay() {
            document.getElementById('score').textContent = `${gameState.totalCorrect}/${gameState.totalAnswered}`;
            document.getElementById('accuracy').textContent = gameState.totalAnswered > 0 ? Math.round((gameState.totalCorrect / gameState.totalAnswered) * 100) + '%' : '0%';
            document.getElementById('streak').textContent = gameState.streak;
            document.getElementById('question-number').textContent = gameState.currentQuestionIndex + 1;
            
            // Update level based on stars
            let level = "Beginner";
            if (gameState.stars >= 25) level = "Expert";
            else if (gameState.stars >= 15) level = "Advanced";
            else if (gameState.stars >= 8) level = "Intermediate";
            document.getElementById('level').textContent = level;
        }

        // Generic incorrect feedback
        function showGenericIncorrectFeedback() {
            const feedbackContainer = document.getElementById('gap-feedback');
            const questions = questionDatabase[gameState.currentSubject];
            const currentQ = questions[gameState.currentQuestionIndex];
            
            // Update visual feedback
            const dots = document.getElementById('attempt-dots').children;
            if (gameState.currentAttempt <= 3) {
                dots[gameState.currentAttempt - 1].classList.add('bg-red-400');
            }
            
            feedbackContainer.innerHTML = `
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-lg">
                    <div class="flex items-center mb-4">
                        <span class="text-3xl mr-3">ü§î</span>
                        <h3 class="text-xl font-bold text-yellow-800">Not quite right...</h3>
                    </div>
                    <p class="text-yellow-700 mb-4">That's not the correct answer. Let me show you the solution:</p>
                </div>
            `;
            
            feedbackContainer.classList.remove('hidden');
            gameState.currentAttempt++;
            gameState.totalAnswered++;
            
            // Show step-by-step for any wrong answer
            const questionData = gameState.showingFollowUp && currentQ.followUpQuestion ? currentQ.followUpQuestion : currentQ;
            showStepByStepFix(questionData);
        }

        // Utility functions
        function retryQuestion() {
            document.getElementById('gap-answer').value = '';
            document.getElementById('gap-feedback').innerHTML = '';
            document.getElementById('gap-feedback').classList.add('hidden');
            document.getElementById('gap-answer').focus();
            
            // Reset attempt dots
            const dots = document.getElementById('attempt-dots').children;
            for (let i = 0; i < dots.length; i++) {
                dots[i].classList.remove('bg-red-400', 'bg-green-400');
                dots[i].classList.add('bg-gray-200');
            }
            gameState.currentAttempt = 1;
        }

        function showHint() {
            const questions = questionDatabase[gameState.currentSubject];
            const currentQ = questions[gameState.currentQuestionIndex];
            const questionData = gameState.showingFollowUp && currentQ.followUpQuestion ? currentQ.followUpQuestion : currentQ;
            
            const hintHTML = `
                <div class="bg-blue-100 border border-blue-300 p-4 rounded-lg mt-4">
                    <h4 class="font-bold text-blue-800 mb-2">üí° Helpful Hint:</h4>
                    <p class="text-blue-700">Look at step 1: ${questionData.steps[1].step}</p>
                </div>
            `;
            
            document.getElementById('gap-feedback').innerHTML += hintHTML;
        }

        function nextQuestion() {
            gameState.currentQuestionIndex++;
            gameState.currentAttempt = 1;
            gameState.showingFollowUp = false;
            
            if (gameState.currentQuestionIndex >= questionDatabase[gameState.currentSubject].length) {
                showCompletionMessage();
                return;
            }
            
            loadQuestion();
        }

        function showCompletionMessage() {
            const container = document.querySelector('.question-container');
            container.innerHTML = `
                <div class="text-center p-8 bg-gradient-to-r from-purple-50 to-blue-50 rounded-2xl">
                    <span class="text-6xl mb-4 block">üéâ</span>
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Congratulations!</h2>
                    <p class="text-xl text-gray-600 mb-6">You've completed all ${gameState.currentSubject} questions!</p>
                    <div class="bg-white p-6 rounded-lg shadow-lg max-w-md mx-auto mb-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-2xl font-bold text-purple-600">${gameState.stars} ‚≠ê</p>
                                <p class="text-sm text-gray-600">Stars Earned</p>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-green-600">${Math.round((gameState.totalCorrect / gameState.totalAnswered) * 100)}%</p>
                                <p class="text-sm text-gray-600">Accuracy</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="location.reload()" class="bg-purple-500 text-white px-8 py-3 rounded-lg hover:bg-purple-600 transition-colors font-semibold shadow-lg transform hover:scale-105">
                        üîÑ Practice Again
                    </button>
                </div>
            `;
        }

        // Handle Enter key for submission
        document.addEventListener('DOMContentLoaded', function() {
            const answerInput = document.getElementById('gap-answer');
            if (answerInput) {
                answerInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkGapAnswer();
                    }
                });
            }
            
            // Initialize the first question
            initializeQuestion();
        });

        // Subject switching
        function switchSubject(subject) {
            gameState.currentSubject = subject;
            gameState.currentQuestionIndex = 0;
            gameState.showingFollowUp = false;
            loadQuestion();
            
            // Update active button styling
            document.querySelectorAll('.subject-btn').forEach(btn => {
                btn.classList.remove('bg-purple-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            event.target.classList.remove('bg-gray-200', 'text-gray-700');
            event.target.classList.add('bg-purple-600', 'text-white');
        }

        // Generate study plan based on weaknesses
        function generateStudyPlan() {
            if (Object.keys(gameState.weaknessAreas).length === 0) {
                alert('Complete a few questions first to generate a personalized study plan!');
                return;
            }

            const weakestAreas = Object.entries(gameState.weaknessAreas)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3);

            const studyPlan = `
üéØ Your Personalized Study Plan:

${weakestAreas.map((area, index) => 
    `${index + 1}. Focus on ${area[0]} (${area[1]} mistakes)
   üìö Practice 10-15 problems daily
   ‚è∞ Spend 15-20 minutes on this topic`
).join('\n\n')}

üìà Your current level: ${document.getElementById('level').textContent}
‚≠ê Stars earned: ${gameState.stars}
üéØ Accuracy: ${Math.round((gameState.totalCorrect / gameState.totalAnswered) * 100)}%

Keep practicing to master these concepts! üöÄ
            `;

            alert(studyPlan);
        }
    </script>
                    "Equation verification methods",
                    "Basic quadratic concepts"
                ]
            };
            
            return weakAreasByTopic[topic] || [`${topic} fundamentals`, `${topic} problem-solving steps`];
        }
        
        function generateStudyPlan() {
            alert('üéØ Study Plan Generated!\n\nBased on your performance, we recommend:\n\n' + 
                  (practiceNeeded.length > 0 ? 'üìö Focus on: ' + practiceNeeded.join(', ') + '\n' : '') +
                  (masteredTopics.length > 0 ? '‚úÖ Continue practicing: ' + masteredTopics.join(', ') + '\n' : '') +
                  '\nKeep up the great work! üåü');
        }
        
        // Allow Enter key for input
        document.getElementById('gap-answer').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkGapAnswer();
            }
        });
        
        // Initialize
        loadQuestion();
        updateDisplay();
    </script>
</body>
</html>